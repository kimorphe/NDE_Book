\section{随伴方程式法}
ここまでに議論では，画像化関数$I(\fat{x})$と${\cal I}(\fat{x})$をはじめ与え，
それらがどのように散乱体の像を合成するか，また，２つの画像化関数が互いにどの
ように関係づけられるかを調べてきた．
ここからは，画像化関数を波動場の支配方程式から導く2つの方法を示す．
一つ目は，随伴方程式法によるモデルパラメータの推定問題として
画像化関数が与えられることを示す．
２つ目の方法では，波動場の積分表現に基づく線形化逆散乱解析法において，
散乱体形状を表す特異関数として画像化関数が得られることを示す．
前者の方法からは，時間反転法と同じ形式をもつ画像化関数が，
後者からは，開口合成法の形式を持つ画像化関数が得られる．
時間反転法と開口合成法の関係はこれまで示した通りであることから，
以上の方法全てに共通する側面があることが明らかとなる．
\subsection{問題設定}
領域$B$の内部に存在する散乱体$D$による，スカラー波の散乱問題を考える．
ここでは，モデルパラメータの意味を明確にするために，スカラー場を
圧力場$p(\fat{x},t)$とし，媒体の質量密度を$\rho(\fat{x})$，
粒子速度を$\fat{v}(\fat{x},t)$と表す．このとき，運動量保存則は，
\begin{equation}
	\rho \dot{\fat{v}}= -\nabla p
%	, \ \ (\fat{x}\in B, t\in (0,T_f)
	\label{eqn:YYY_2nd_law}
\end{equation}
と表される．圧力と速度の関係は，ラメ定数$\lambda(\fat{x})$を用いて
\begin{equation}
	\dot{p}=-\lambda \nabla \cdot \fat{v}
	\label{eqn:YYY_pv}
\end{equation}
書けるので，式(\ref{eqn:YYY_2nd_law})と式(\ref{eqn:YYY_pv})から
$\fat{v}$を消去すれば，圧力に関する波動方程式が次のように得られる．
\begin{equation}
	\alpha \ddot{p}-\nabla \cdot \left(\beta  \nabla  p \right)=0
	\label{eqn:YYY_wveq_p}
\end{equation}
ただし，
\begin{equation}
	\alpha(\fat{x}) = \frac{1}{\rho(\fat{x})}, \ \ \beta(\fat{x})=\frac{1}{\lambda(\fat{x})}
	\label{eqn:YYY_consts_ab}
\end{equation}
とした．圧力場の初期条件は，
\begin{equation}
	p(\fat{x},t)=0, \ \ \dot{p}(\fat{x},0)=0
	\label{eqn:YYY_IC_p}
\end{equation}
とし，境界条件はノイマン条件:
\begin{equation}
	\frac{\partial p}{\partial n}(\fat{x},t)=0, \ \ \left( \fat{x} \in  \partial B \right)
	\label{eqn:YYY_BC_p}
\end{equation}
を課す．また，散乱体$D$はインクルージョンであるとし，
モデルパラメータである，質量密度とラメ定数を，次のように与える．
\begin{equation}
	\rho (\fat{x})=
	\left\{
	\begin{array}{cc}
		\rho_0 +\Delta \rho(\fat{x}) & (\fat{x}\in D) \\
		\rho_0 & (\rm otherwise)
	\end{array}
	\right.
	\label{eqn:YYY_rho_x}
\end{equation}
\begin{equation}
	\lambda (\fat{x})=
	\left\{
	\begin{array}{cc}
		\lambda_0 +\Delta \lambda(\fat{x}) & (\fat{x}\in D) \\
		\lambda_0 & (\rm otherwise)
	\end{array}
	\right.
	\label{eqn:YYY_rho_x}
\end{equation}
すなわち，インクルージョンは均質媒体に埋め込まれているとする．
以下では，バックグラウンドの物性$(\rho_0, \lambda_0)$は既知とし，
$D$からの散乱波$p^{sc}(\fat{x},t)$を観測して$D$を再構成することを
考える．そのためには，$\lambda(\fat{x})$あるいは$\rho(\fat{x})$を
適当な画像化領域において再構成すればよい．なお，観測は
$\left\{ \fat{x}_i, i=1,\dots M\right\}$において，$0\leq  t\leq T$の
時間範囲で行い，圧力の時間波形データ
\begin{equation}
	{\cal D}
	=
	\left\{ 
		p(\fat{x}_i, t)=p_i^{0}(t)\left|
		i=1,2,\dots M, \, 0\leq t \leq T
		\right.
	\right\}
	\label{eqn:YYY_00}
\end{equation}
が得られているとする．ここでは，データ$\cal D$から$\rho$と$\lambda$を再構成する問題を，
次のようなコスト関数:
\begin{equation}
	\chi (\fat{m})=\frac{1}{2} 
	\sum_{i=1}^M\int_0^T \left| p(\fat{x},t)-p_i^0(t))\right|^2dt
	\label{eqn:YYY_01}
\end{equation}
を最小化するように，モデルパラメータ
\begin{equation}
	\fat{m}=(\alpha,\,\beta)=\left( \rho^{-1},\, \lambda^{-1} \right)
	\label{eqn:YYY_02}
\end{equation}
を決定する問題として考える．
なお，$p(\fat{x},t)$は，$\fat{m}$を指定したときの散乱問題の解であり，
式(\ref{eqn:YYY_01})の右辺は $p(\fat{x},t)$を通じて$\fat{m}$に依存する．
\subsection{随伴方程式法}
コスト関数$\chi(\fat{m})$を最小化する際，適当なモデルパラメータ$\fat{m}$の初期値からはじめ，
コスト関数の値が減少する方向へ$\fat{m}$を修正する勾配法を適用する．
$\chi(\fat{m})$の$\fat{m}$に関する勾配は，次のように定義される．
\begin{equation}
	\nabla_m \chi(\fat{m}) 
	\delta \fat{m}
	= \lim_{\varepsilon \rightarrow 0}
	\frac{1}{\varepsilon}
	\left[
		\chi(\fat{m}+\varepsilon \delta \fat{m}) - \chi(\fat{m})
	\right]
	\label{eqn:YYY_03}
\end{equation}
ここに$\delta \fat{m}$は，$\fat{m}+\delta \fat{m}$がモデルパラメータの
空間に属するような任意の変分を表す．
$\delta\fat{m}$方向へのコストの勾配$\nabla \chi (\fat{m})\delta \fat{m}$は，
以下に示すように随伴方程式法(adjoint method)を用いて効率的に求めることができる．

はじめに，次のように拡張されたコスト関数を定義する．
\begin{equation}
	\chi^*(\fat{m})
	=
	\chi(\fat{m})
	+
	\int_B\int_0^T 
	p^*(\fat{x},t)
	\left\{ 
		\alpha \ddot{p}-\nabla \cdot \left(\beta  \nabla  p \right)
	\right\}
	dt d\fat{x}
	\label{eqn:YYY_chi2}
\end{equation}
右辺第二項は，圧力場の支配方程式(\ref{eqn:YYY_wveq_p})を制約条件として加えるための
ラグランジュ乗数項で，$p^*(\fat{x},t)$は任意の関数である．
コスト関数の被積分関数を
\begin{equation}
	\chi_1(\fat{m})=\frac{1}{2} 
	\sum_{i=1}^M
	\left| p(\fat{x},t)-p^0(\fat{x},t)\right|^2
	\delta(\fat{x}-\fat{x}_i )
	\label{eqn:YYY_04}
\end{equation}
で，$B\times (0,T)$での積分を
\begin{equation}
	\left< \cdot \right>=\int_G\int_0^T (\cdot )dtd\fat{x}
	\label{eqn:YYY_05}
\end{equation}
と書くとき，コスト関数は
\begin{equation}
	\chi (\fat{m})=\left< \chi_1(\fat{m} )\right>
	\label{eqn:}
\end{equation}
と表すことができる．また，波動方程式を表す微分作用素$L$を
\begin{equation}
	L(p,\fat{m})=\alpha \ddot{p}-\nabla \cdot \left(\beta  \nabla  p \right)
	\label{eqn:YYY_06}
\end{equation}
と定義する．これを踏まえて式(\ref{eqn:YYY_chi2})右辺のラグランジュ乗数項を書けば，
\begin{equation}
	\int_B\int_0^T 
	p^*(\fat{x},t)
	\left\{ 
		\alpha \ddot{p}-\nabla \cdot \left(\beta  \nabla  p \right)
	\right\}
	dt d\fat{x}
	=
	\left< p^* L(p,\fat{m}) \right>
	\label{eqn:}
\end{equation}
となるので，拡張されたコスト関数は
\begin{equation}
	\chi^*(\fat{m}) 
	=
	\left< \chi_1 (\fat{m})\right>
	+
	\left< p^* L(p,\fat{m})\right>
	\label{eqn:YYY_chi2s}
\end{equation}
と表される．
圧力場$p$はモデルパラメータ$\fat{m}$に依存するので，モデルパラメータの変化$\delta \fat{m}$
に対応する圧力場の変化を
\begin{equation}
	\delta p= \nabla_m p \delta \fat{m}
	\label{eqn:YYY_var_p}
\end{equation}
とすれば，式(\ref{eqn:YYY_chi2s})の$\delta \fat{m}$方向への勾配を次にように表すことができる．
\begin{equation}
	\nabla_m \chi^* \delta \fat{m}
	=
	\nabla_p \chi \delta p
	+
	\nabla_p \left< p^*  L(p,\fat{m}) \right> \delta p
	+
	\nabla_m \left< p^*  L(p,\fat{m}) \right> \delta \fat{m}
	\label{eqn:YYY_dchi2}
\end{equation}
式(\ref{eqn:YYY_dchi2})右辺のそれぞれの項は
\begin{equation}
	\nabla_p \chi \delta p
	=  
	\left< \nabla_p \chi_1 \delta p \right> 
	\label{eqn:YYY_dp1}
\end{equation}
\begin{equation}
	\nabla_p \left< p^*  L(p,\fat{m}) \right> \delta p
	=  
	\left< p^*  \left\{ \nabla_p L(p,\fat{m})\delta p \right\}\right> 
	\label{eqn:YYY_dp2}
\end{equation}
\begin{equation}
	\nabla_m \left< p^*  L(p,\fat{m}) \right> \delta \fat{m}
	=
	\left< p^*  \left\{ \nabla_m L(p,\fat{m}) \delta \fat{m}\right\}\right> 
	\label{eqn:YYY_dm3}
\end{equation}
とすることができる．これらの式の右辺に現れる勾配を具体的に計算すると，それぞれ以下のようになる．
\begin{equation}
	\nabla_p \chi_1 =
	\sum_{i=1}^M \left\{p(\fat{x},t)-p^0_i(t)\right\} \delta(\fat{x}-\fat{x}_i)
	\label{eqn:YYY_dm_chi1}
\end{equation}
\begin{equation}
	\nabla_p L(p,\fat{m})\delta p 
	=
	L(\delta p,\fat{m})
	\label{eqn:YYY_dp_L}
\end{equation}
\begin{equation}
	\nabla_m L(p,\fat{m})\delta \fat{m} 
	=
	L(p,\delta \fat{m})
	\label{eqn:YYY_dm_L}
\end{equation}
式(\ref{eqn:YYY_dp_L})を式(\ref{eqn:YYY_dp2})に用いれば，
\begin{equation}
	\left< p^*  \left\{ \nabla_p L(p,\fat{m})\delta p \right\} \right> 
	=
	\left< p^*  L(\delta p,\fat{m}) \right> 
	=
	\left<
		\alpha p^*\delta\ddot{p}
	\right>
	-
	\left<
		p^* \left( \nabla \beta \nabla \delta p\right)
	\right>
	\label{eqn:YYY_dp2_ab}
\end{equation}
となる．式(\ref{eqn:YYY_dp2_ab})の右辺第1項は，部分積分を行い次のように書き直すことができる．
\begin{equation}
	\left<
		\alpha p^*\delta\ddot{p}
	\right>
	=
	\left[ 
		\alpha p^* \delta \dot{p}	
	\right]_0^T
	-
	\left[ 
		\alpha \dot{p}^* \delta p	
	\right]_0^T
	+
	\left< \alpha\ddot{p} \delta p \right>
	\label{eqn:YYY_08}
\end{equation}
一方，式(\ref{eqn:YYY_dp2_ab})右辺の第2項は，発散定理を使って
\begin{eqnarray}
	\left<
		p^* \cdot \left( \nabla \beta \nabla \delta p\right)
	\right>
	&=&
	\left<
		\nabla\cdot
		\left( \beta p^*\nabla \delta p -\beta \delta p \nabla p^* \right)
	\right>
	+
	\left<
		\delta p \nabla\cdot \left( \beta \nabla p^* \right)
	\right> \\
	\label{eqn:YYY_09}
	&=&
	\int_0^T\int_{\partial B}
	\beta\left( 
		p^* \frac{\partial \delta p}{\partial n}
		-
		-\delta p \frac{\partial p^*}{\partial n}
	\right)
	dS
	dt
	+
	\left<
		\delta p \nabla\cdot \left( \beta \nabla p^* \right)
	\right>
	\label{eqn:YYY_10}
\end{eqnarray}
と変形できる．ここで，$\delta p$と$\delta \dot{p}$の初期条件は
\begin{equation}
	\delta p(\fat{x},0)=0, \ \ \delta \dot{p} (\fat{x},0)=0
	\label{eqn:YYY_11}
\end{equation}
としてよい．また，$p^*$の任意性を利用し，時間に関して終端条件
\begin{equation}
	p^*(\fat{x},T)=0, \ \ \dot{p}^*(\fat{x},T)=0 
	\label{eqn:YYY_12}
\end{equation}
を，空間に関してノイマン条件
\begin{equation}
	\left. \frac{\partial p^*}{\partial n}
	\right|_{\partial B}=0
	\label{eqn:yyy_13}
\end{equation}
を課せば，式(\ref{eqn:YYY_dp2})を次のように書くことができる．
\begin{equation}
	\left< p^*  \left\{ \nabla_p L(p,\fat{m})\delta p \right\} \right> 
	=
	\left< \alpha \ddot{p}^* \delta p\right>
	-
	\left<
		\delta p \nabla\cdot \left( \beta \nabla p^* \right)
	\right>
	=
	\left< L(p^*,\fat{m}) \delta p\right> 
	\label{eqn:YYY_14}
\end{equation}
以上を踏まえてコスト関数の勾配(\ref{eqn:YYY_dchi2})を書けば，
\begin{equation}
	\nabla_m \chi^* \delta \fat{m}
	=
	\left< 
		\left\{L(p^*,\fat{m})+\nabla_p\chi_1\right\} \delta p
	\right>
	+
	\left< p^*  L(p,\delta \fat{m}) \right> 
	\label{eqn:YYY_dchi2_adj}
\end{equation}
となる．このことから，
\begin{equation}
	L(p^*,\fat{m})+\nabla_p\chi_1=0
	\label{eqn:YYY_adj_PDE}
\end{equation}
となるように$p^*$を選べば，
\begin{equation}
	\nabla_m \chi^* \delta \fat{m}
	=
	\left< p^*  \cdot L(p,\delta \fat{m}) \right> 
	\label{eqn:YYY_gradX0}
\end{equation}
とすることができる．式(\ref{eqn:YYY_adj_PDE})は随伴方程式と呼ばれる．
ここでは，随伴方程式は元の方程式である$L(p,\fat{m})=0$と同じ
波動方程式で，$-\nabla \chi_1(p)$はそのソース項となっている．
\subsection{随伴場と画像化関数}
式(\ref{eqn:YYY_gradX0})の右辺を評価することで，圧力場に関する任意の変分$\delta p$
を計算することなくコスト関数の勾配が得られる．ただしそのためには随伴問題の解$p^*(\fat{x},t)$
を$B \times (0,T)$において求める必要がある．
$p^*$はこれまでの議論より、次の条件を満足する場である．
\begin{equation}
	L(p^*,\fat{m})=
	\alpha \ddot{p}^* -\nabla\cdot \left( \beta \nabla p^* \right)
	=	
	-\nabla_p\chi_1
	\label{eqn:YYY_adj_PDE_rep}
\end{equation}
\begin{equation}
	p*(\fat{x},T)=0, \ \ \dot{p}^*(\fat{x},T)=0
	\label{eqn:YYY_TC_rep}
\end{equation}
\begin{equation}
	\left. \frac{\partial p^*}{\partial n}\right|_{\partial B}=0
	\label{eqn:YYY_BC_rep}
\end{equation}
演算子$L(p^*,\fat{m})$は時間反転に対して不変で，
終端条件(\ref{eqn:YYY_TC_rep})は$t\rightarrow T-t$によって初期条件
\begin{equation}
	p*(\fat{x},0)=0, \ \ \dot{p}^*(\fat{x},0)=0
	\label{eqn:YYY_IC_adj}
\end{equation}
として扱うことができる．このことから$G\times (0,T)$における初期値問題を解くことで
随伴場$p^*(\fat{x},t)$が得られる．その際，ソース項である式(\ref{eqn:YYY_dm_chi1})
において$p^{0}(\fat{y}_i,t)$には観測データ${\cal D}$を用い，
$p(\fat{x},t)$には，現時点での$\fat{m}$の推定値を用いて順問題
$L(p,\fat{m})=0$を解いて得られた圧力場$p(\fat{x},t)$を用いる．
その結果得られる勾配$\nabla_m\chi \delta \fat{m}$から
得られるコスト関数の下降方向へモデルパラメータ$\delta \fat{m}$を繰り返し修正すれば，
最終的に未知のモデルパラメータを決定することができる．
このような方法はフルウェーブインバージョンと呼ばれる．
ここでは，フルウェーブインバージョンのような反復は行わず，一回の計算で散乱体の
形状を再構成することを考える．
そこで，モデルパラメータの初期値を
\begin{equation}
	\fat{m}=\left(\rho_0^{-1},\, \lambda_0^{-1} \right)
	\label{eqn:YYY_16}
\end{equation}
と均質材として与える．この場合，随伴方程式のソース項に含まれる
順問題の圧力場は入射場$p^{in}(\fat{x},t)$意味し，
$p(\fat{x},t)-p^{0}(\fat{x},t)$は，散乱波$p^{sc}(\fat{x},t)$を時間反転した
\begin{equation}
	-\nabla_p\chi_1 = 
	-\sum_{i=1}^M p^{sc}(\fat{x},T-t)\delta(\fat{x}-\fat{y}_i)
	\label{eqn:YYY_17}
\end{equation}
となる．従って、観測した散乱波形を時間反転して媒体に入力することで励起される波動場が
，随伴場の物理的な意味になる．
最後に，式(\ref{eqn:YYY_gradX0})を計算し易い形に書き直す．式(\ref{eqn:YYY_gradX0})において
演算子の部分を具体的に書けば,
\begin{equation}
	\left< p^*  \cdot L(p,\delta \fat{m}) \right> 
	=
	\left< \delta \alpha p^*  \ddot{p} \right> 
	-
	\left< p^*  \nabla\cdot \left( \delta \beta \nabla p \right)\right> 
	\label{eqn:YYY_18}
\end{equation}
で,右辺の項を終端条件(\ref{eqn:YYY_TC_rep})と境界条件(\ref{eqn:YYY_BC_p})を考慮して部分積分によって
変形すれば，
\begin{equation}
	\left< \alpha p^*  \ddot{p} \right> 
	=\int_G \left( \int_0^T \dot{p}\dot{p}^* dt \right) \delta \alpha  d\fat{x}
	\label{eqn:YYY_19}
\end{equation}
\begin{equation}
	-\left< p^*  \nabla\cdot \left( \delta \beta \nabla p \right)\right> 
	=
	\int_G \left( \int_0^T \nabla p\cdot \nabla p^* dt \right) \delta \beta  d\fat{x}
	\label{eqn:YYY_20}
\end{equation}
が得られる．そこで，
\begin{equation}
	K_\alpha(\fat{x})=-\int_0^T \dot{p}\dot{p}^* dt 
	\label{eqn:YYY_Ka}
\end{equation}
\begin{equation}
	K_\beta(\fat{x})=-\int_0^T \nabla p\cdot \nabla p^* dt 
	\label{eqn:YYY_Kb}
\end{equation}
とおけば，$K_\alpha(\fat{x})$と$K_\beta(\fat{x})$が，それぞれ
$\rho$と$\lambda$の推定値を修正すべき方向であることが分かる．
従って，$K_\alpha(\fat{x})$や$K_\beta(\fat{x})$，あるいはその組み合わせを
画像化関数として用いれば，密度や弾性係数差の変動を推定することにより
散乱体の像合成を行うことができる．特に，式(\ref{eqn:YYY_Ix_trev})において
$U(\fat{x})=\dot{p}$であると考えれば，$K_\alpha(\fat{x})$は，発見的な方法で
導かれた時間反転法による再構成式を与えることに気付く．
随伴方程式法では形状再構成を行う散乱体は点散乱体である必要は無い．
このことから，点散乱体の再構成を念頭において導出した式(\ref{eqn:YYY_Ix_trev})
の再構成式を大きさのある散乱体に適用することの根拠が得られる．
さらに，時間反転法は開口合成法の拡張とみなせることはこれまで議論した通りである
ことから，開口合成法も随伴方程式法から導出できることが分かる．
より具体的に言えば，随伴方程式法で得られた$K_\alpha(\fat{x})$や$K_\beta(\fat{x})$
の一部を用い，その計算に必要となる波動場$ p(\fat{x},t)$や$p^*(\fat{x},t)$
を非常に簡単な近似解で置き換えた結果として時間反転法や開口合成法の再構成式が
得られるという形での導出が可能となる．

